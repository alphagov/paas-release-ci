<% repo_name = File.basename(uri,'.git') %>
- name: s3-init
  plan:
    - task: s3-init
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: governmentpaas/curl-ssl
          run:
            path: sh
            args:
              - -e
              - -c
              - |
                echo "Hello World"

- name: build-<%= branch_name %>
  plan:
  - get: release-tarballs
  - get: release
    resource: <%= repo_name %>-<%= branch_name %>
    params: {depth: 20}
    trigger: true
  - task: build-release
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: governmentpaas/bosh-cli
      inputs:
        - name: release
      outputs:
        - name: release-tarballs
      run:
        path: sh
        args:
        - -e
        - -c
        - |
          cd release
          NAME=$(awk '/^final_name/ {print $2}' config/final.yml)
          bosh create release --name $NAME --force --with-tarball --timestamp-version
          cp dev_releases/$NAME/$NAME-*.tgz ../release-tarballs
      on_success:
        put: release-tarballs
        params:
          file: release-tarball/*.tgz
          acl: public-read

- name: test-<%= branch_name %>
  plan:
  - get: release-tarballs
    passed: ['build-<%= branch_name %>']
  - task: test-release
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: governmentpaas/bosh-cli
      inputs:
        - name: release-tarballs
      run:
        path: sh
        args:
        - -e
        - -c
        - |
          cd release-tarballs
          ls -al
